<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Daniel Oberbauer">
  <meta name="description" content="Posts and writings by Daniel Oberbauer">


<meta name="keywords" content="">

  <title>
    Daniel Oberbauer
&ndash; Toy Camera  </title>

</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="">
        <img src="/theme/images/logo.png" alt="logo">
      </a>
      <h2><a href="">Daniel Oberbauer</a></h2>
      <p></p>
      <ul>
        <li><a href="/category/art.html">Art</a></li>
        <li><a href="/category/exploration.html">Exploration</a></li>
        <li><a href="/category/project.html">Project</a></li>
        <li><a href="/category/resources.html">Resources</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="">Index</a> &brvbar; <a href="/archives.html">Archives</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="/toy-camera.html">Toy Camera</a></h1>
  </div>
  <div class="article_meta">
    <p>Posted on: Sat 24 June 2023</p>
  </div>
  <div class="article_text">
    <h3>What is Toy Camera?</h3>
<p>Toy Camera is a Raspberry Pi Zero W / OpenCV / Python project. It's a low resolution camera that can take pictures with a handful of filters. It's front-facing so you can take selfies and whatnot.</p>
<h3>Why did you make it?</h3>
<ul>
<li>I wanted to</li>
<li>I had the parts</li>
<li>It was a fun Python exercise</li>
<li>My Pi Zero W wasn't being used</li>
</ul>
<h3>What parts did you use?</h3>
<ul>
<li>Raspberry Pi Zero W</li>
<li>32 GB microSD</li>
<li>Adafruit 1.8in TFT</li>
<li>Raspberry Pi Camera module (or third-party raspberry pi compatible camera)</li>
<li>Camera cable</li>
<li>Case</li>
</ul>
<p>(Future)
- Battery
- battery charging circuit </p>
<h3>How do I install this?</h3>
<p>I'm using Raspberry Pi OS Buster Lite (no desktop). I haven't tried other OS versions. Installing an OS is beyond the scope of this article.</p>
<p>Let's start with updating apt, installing pip, git and PIL.  </p>
<div class="highlight"><pre><span></span><code>sudo apt-get update
sudo apt-get upgrade
sudo apt-get install python3-pip
sudo apt-get install git
sudo apt-get install python3-pil
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">pip3</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">upgrade</span><span class="w"> </span><span class="n">setuptools</span>
<span class="n">cd</span><span class="w"> </span><span class="o">~</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">pip3</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">upgrade</span><span class="w"> </span><span class="n">adafruit</span><span class="o">-</span><span class="n">python</span><span class="o">-</span><span class="n">shell</span>
<span class="n">wget</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">adafruit</span><span class="o">/</span><span class="n">Raspberry</span><span class="o">-</span><span class="n">Pi</span><span class="o">-</span><span class="n">Installer</span><span class="o">-</span><span class="n">Scripts</span><span class="o">/</span><span class="k">master</span><span class="o">/</span><span class="n">raspi</span><span class="o">-</span><span class="n">blinka</span><span class="o">.</span><span class="n">py</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">python3</span><span class="w"> </span><span class="n">raspi</span><span class="o">-</span><span class="n">blinka</span><span class="o">.</span><span class="n">py</span>

<span class="n">pip3</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">adafruit</span><span class="o">-</span><span class="n">circuitpython</span><span class="o">-</span><span class="n">rgb</span><span class="o">-</span><span class="n">display</span>
<span class="n">pip3</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">upgrade</span><span class="w"> </span><span class="o">--</span><span class="n">force</span><span class="o">-</span><span class="n">reinstall</span><span class="w"> </span><span class="n">spidev</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">fonts</span><span class="o">-</span><span class="n">dejavu</span>

<span class="n">sudo</span><span class="w"> </span><span class="n">pip3</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">opencv</span><span class="o">-</span><span class="n">python</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">dir</span>

<span class="c1"># If pip doesn&#39;t work</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">cmake</span><span class="w"> </span><span class="n">build</span><span class="o">-</span><span class="n">essential</span><span class="w"> </span><span class="n">pkg</span><span class="o">-</span><span class="n">config</span><span class="w"> </span><span class="n">git</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">libjpeg</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libtiff</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libjasper</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libpng</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libwebp</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libopenexr</span><span class="o">-</span><span class="n">dev</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">libavcodec</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libavformat</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libswscale</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libv4l</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libxvidcore</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libx264</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libdc1394</span><span class="o">-</span><span class="mi">22</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libgstreamer</span><span class="o">-</span><span class="n">plugins</span><span class="o">-</span><span class="n">base1</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libgstreamer1</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">dev</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">python3</span><span class="o">-</span><span class="n">numpy</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">libgtk</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libqtgui4</span><span class="w"> </span><span class="n">libqtwebkit4</span><span class="w"> </span><span class="n">libqt4</span><span class="o">-</span><span class="n">test</span><span class="w"> </span><span class="n">python3</span><span class="o">-</span><span class="n">pyqt5</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">libatlas</span><span class="o">-</span><span class="n">base</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">liblapacke</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">gfortran</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">libhdf5</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libhdf5</span><span class="o">-</span><span class="mi">103</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">python3</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">python3</span><span class="o">-</span><span class="n">pip</span><span class="w"> </span><span class="n">python3</span><span class="o">-</span><span class="n">numpy</span>
<span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">opencv</span><span class="o">/</span><span class="n">opencv</span><span class="o">.</span><span class="n">git</span>
<span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">opencv</span><span class="o">/</span><span class="n">opencv_contrib</span><span class="o">.</span><span class="n">git</span>
</code></pre></div>

<h3>How does it work?</h3>
<p><strong>Overview</strong></p>
<p>The Adafruit TFT for Raspberry Pi has two buttons. I've set it up so the left button takes a picture and the right button changes mode. Pressing both buttons shuts the Pi off.</p>
<p>TFT Display Definitions
Code adapted from ladyada of Adafruit Industries.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># SPDX-FileCopyrightText: 2021 ladyada for Adafruit Industries</span>
<span class="c1"># SPDX-License-Identifier: MIT</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/pi/.local/lib/python3/site-packages&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">digitalio</span>
<span class="kn">import</span> <span class="nn">board</span>
<span class="kn">from</span> <span class="nn">adafruit_rgb_display</span> <span class="kn">import</span> <span class="n">st7789</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>
<span class="c1">#from adafruit_rgb_display.rgb import color565</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="sd">&#39;&#39;&#39; Display definitions &#39;&#39;&#39;</span>
<span class="c1"># Configuration for CS and DC pins for Raspberry Pi</span>
<span class="n">cs_pin</span> <span class="o">=</span> <span class="n">digitalio</span><span class="o">.</span><span class="n">DigitalInOut</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">CE0</span><span class="p">)</span>
<span class="n">dc_pin</span> <span class="o">=</span> <span class="n">digitalio</span><span class="o">.</span><span class="n">DigitalInOut</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">D25</span><span class="p">)</span>
<span class="n">reset_pin</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">BAUDRATE</span> <span class="o">=</span> <span class="mi">64000000</span>  <span class="c1"># The pi can be very fast!</span>
<span class="c1"># Create the ST7789 display:</span>
<span class="n">display</span> <span class="o">=</span> <span class="n">st7789</span><span class="o">.</span><span class="n">ST7789</span><span class="p">(</span>
    <span class="n">board</span><span class="o">.</span><span class="n">SPI</span><span class="p">(),</span>
    <span class="n">cs</span><span class="o">=</span><span class="n">cs_pin</span><span class="p">,</span>
    <span class="n">dc</span><span class="o">=</span><span class="n">dc_pin</span><span class="p">,</span>
    <span class="n">rst</span><span class="o">=</span><span class="n">reset_pin</span><span class="p">,</span>
    <span class="n">baudrate</span><span class="o">=</span><span class="n">BAUDRATE</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span>
    <span class="n">x_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">y_offset</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">backlight</span> <span class="o">=</span> <span class="n">digitalio</span><span class="o">.</span><span class="n">DigitalInOut</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">D22</span><span class="p">)</span>
<span class="n">backlight</span><span class="o">.</span><span class="n">switch_to_output</span><span class="p">()</span>
<span class="n">backlight</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">buttonA</span> <span class="o">=</span> <span class="n">digitalio</span><span class="o">.</span><span class="n">DigitalInOut</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">D23</span><span class="p">)</span>
<span class="n">buttonB</span> <span class="o">=</span> <span class="n">digitalio</span><span class="o">.</span><span class="n">DigitalInOut</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">D24</span><span class="p">)</span>
<span class="n">buttonA</span><span class="o">.</span><span class="n">switch_to_input</span><span class="p">()</span>
<span class="n">buttonB</span><span class="o">.</span><span class="n">switch_to_input</span><span class="p">()</span>

<span class="sd">&#39;&#39;&#39; Image Definitions &#39;&#39;&#39;</span>

<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">height</span> <span class="o">=</span> <span class="n">display</span><span class="o">.</span><span class="n">width</span>  <span class="c1"># swap height/width to make it landscape!</span>
<span class="n">width</span> <span class="o">=</span> <span class="n">display</span><span class="o">.</span><span class="n">height</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
<span class="n">rotation</span> <span class="o">=</span> <span class="mi">270</span>
<span class="n">text_rotation</span> <span class="o">=</span> <span class="mi">90</span>
<span class="n">text_x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">text_y</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">outline</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="c1">#Clear screen</span>
<span class="n">display</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">rotation</span><span class="p">)</span>
<span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="s2">&quot;/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>

<span class="sd">&#39;&#39;&#39; Camera definitions &#39;&#39;&#39;</span>

<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">240</span><span class="p">,</span><span class="mi">180</span><span class="p">)</span>
<span class="n">cap_w</span> <span class="o">=</span> <span class="mi">640</span>
<span class="n">cap_h</span> <span class="o">=</span> <span class="mi">480</span>
<span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span> <span class="n">cap_w</span><span class="p">)</span>
<span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span> <span class="n">cap_h</span><span class="p">)</span>

<span class="sd">&#39;&#39;&#39; Mode definitions &#39;&#39;&#39;</span>

<span class="n">current_mode</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">modes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Default&quot;</span><span class="p">,</span><span class="s2">&quot;Pixel&quot;</span><span class="p">,</span><span class="s2">&quot;BW&quot;</span><span class="p">,</span><span class="s2">&quot;Negative&quot;</span><span class="p">,</span><span class="s2">&quot;Sepia&quot;</span><span class="p">,</span><span class="s2">&quot;Sketch&quot;</span><span class="p">,</span><span class="s2">&quot;Water color&quot;</span><span class="p">,</span><span class="s2">&quot;Detect Face&quot;</span><span class="p">,</span><span class="s2">&quot;Psychedelic&quot;</span><span class="p">]</span> <span class="c1">#Mode str len &lt;= x chars</span>
<span class="k">global</span> <span class="n">face_cascade</span>
<span class="n">face_cascade</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CascadeClassifier</span><span class="p">(</span><span class="s1">&#39;haarcascade_frontalface_default.xml&#39;</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39; Cycle Mode Function &#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">cycle_mode</span><span class="p">(</span><span class="n">_current_mode</span><span class="p">,</span><span class="n">_modes</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_current_mode</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">_modes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">_current_mode</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">#reset it to zero</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_current_mode</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">_current_mode</span>

<span class="k">def</span> <span class="nf">process_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">current_mode</span><span class="p">,</span><span class="n">modes</span><span class="p">):</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">current_mode</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">modes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1">#Default</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">modes</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="c1">#Pixel</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">mode_pixel</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">modes</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="c1">#BW</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">mode_bw</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">modes</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="c1">#Negative</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">mode_negative</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">modes</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="c1">#Sepia</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">mode_sepia</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">modes</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="c1">#Sketch</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">mode_sketch</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">modes</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="c1">#Water color</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">mode_wc</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">modes</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="c1">#Detect Face</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">mode_face</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">modes</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="c1">#Psychedelic</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">mode_psych</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">frame</span>
<span class="sd">&#39;&#39;&#39; --- MODES --- &#39;&#39;&#39;</span>

<span class="sd">&#39;&#39;&#39; Pixel Mode &#39;&#39;&#39;</span>
<span class="k">def</span> <span class="nf">mode_pixel</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">fh</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">fh</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_NEAREST</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39; BW Mode &#39;&#39;&#39;</span>
<span class="k">def</span> <span class="nf">mode_bw</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frame</span>

<span class="sd">&#39;&#39;&#39; Negative Mode &#39;&#39;&#39;</span>
<span class="k">def</span> <span class="nf">mode_negative</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frame</span>

<span class="sd">&#39;&#39;&#39; Sepia Mode &#39;&#39;&#39;</span>
<span class="k">def</span> <span class="nf">mode_sepia</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mf">0.272</span><span class="p">,</span> <span class="mf">0.534</span><span class="p">,</span> <span class="mf">0.131</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mf">0.349</span><span class="p">,</span> <span class="mf">0.686</span><span class="p">,</span> <span class="mf">0.168</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mf">0.393</span><span class="p">,</span> <span class="mf">0.769</span><span class="p">,</span> <span class="mf">0.189</span><span class="p">]]))</span> <span class="c1"># multipying image with special sepia matrix</span>
    <span class="n">frame</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">frame</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">255</span> <span class="c1"># normalizing values greater than 255 to 255</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="c1"># converting back to int</span>
    <span class="k">return</span> <span class="n">frame</span>

<span class="sd">&#39;&#39;&#39; Sketch Mode &#39;&#39;&#39;</span>
<span class="k">def</span> <span class="nf">mode_sketch</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">pencilSketch</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">sigma_s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">sigma_r</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">shade_factor</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frame</span>

<span class="sd">&#39;&#39;&#39; Water Color Mode &#39;&#39;&#39;</span>
<span class="k">def</span> <span class="nf">mode_wc</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">stylization</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">sigma_s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">sigma_r</span><span class="o">=</span><span class="mf">0.07</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frame</span>

<span class="sd">&#39;&#39;&#39; Face Detection Mode &#39;&#39;&#39;</span>
<span class="k">def</span> <span class="nf">mode_face</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">faces</span> <span class="o">=</span> <span class="n">face_cascade</span><span class="o">.</span><span class="n">detectMultiScale</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">scaleFactor</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">minNeighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">minSize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">faces</span><span class="p">))</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">)</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">:</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),(</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frame</span>
<span class="sd">&#39;&#39;&#39; Psychedelic Color Mode &#39;&#39;&#39;</span>
<span class="k">def</span> <span class="nf">mode_psych</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">img_hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>
    <span class="n">n_shift</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">img_hsv</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_hsv</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_shift</span><span class="p">)</span> <span class="o">%</span> <span class="mi">181</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_hsv</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_HSV2BGR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frame</span>

<span class="sd">&#39;&#39;&#39; Main loop &#39;&#39;&#39;</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">buttonA</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="n">buttonB</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="c1"># none pressed</span>
        <span class="c1"># Viewfinder</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span>
        <span class="n">display</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">rotation</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">buttonB</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">buttonA</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>  <span class="c1"># just button A pressed</span>
        <span class="c1">#Take picture and display result for 5 seconds</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">outline</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">text_x</span><span class="p">,</span> <span class="n">text_y</span><span class="p">),</span> <span class="s2">&quot;Processing...&quot;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">)</span>
        <span class="n">display</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">text_rotation</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">process_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">current_mode</span><span class="p">,</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">--%H-%M-%S&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;pics/&quot;</span> <span class="o">+</span> <span class="n">modes</span><span class="p">[</span><span class="n">current_mode</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">timestr</span> <span class="o">+</span> <span class="s2">&quot;.jpg&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">outline</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">text_x</span><span class="p">,</span> <span class="n">text_y</span><span class="p">),</span> <span class="s2">&quot;Done!&quot;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">)</span>
        <span class="n">display</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">text_rotation</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">display</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">rotation</span><span class="p">)</span> <span class="c1">#Display it</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="c1"># Wait for a few seconds (ms?) </span>
        <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">outline</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#Clear screen</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">text_x</span><span class="p">,</span><span class="n">text_y</span><span class="p">),</span> <span class="n">modes</span><span class="p">[</span><span class="n">current_mode</span><span class="p">],</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">)</span> 
        <span class="n">display</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">text_rotation</span><span class="p">)</span> <span class="c1">#Display the current mode</span>

    <span class="k">if</span> <span class="n">buttonA</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">buttonB</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>  <span class="c1"># just button B pressed</span>
        <span class="c1">#Change Mode</span>

        <span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">outline</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">current_mode</span> <span class="o">=</span> <span class="n">cycle_mode</span><span class="p">(</span><span class="n">current_mode</span><span class="p">,</span><span class="n">modes</span><span class="p">)</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">text_x</span><span class="p">,</span> <span class="n">text_y</span><span class="p">),</span> <span class="n">modes</span><span class="p">[</span><span class="n">current_mode</span><span class="p">],</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">)</span>
        <span class="n">display</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">text_rotation</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">buttonA</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">buttonB</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>  <span class="c1">#both pressed</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;sudo showdown now&#39;</span><span class="p">)</span>
        <span class="k">break</span>
<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="n">draw</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">outline</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="c1">#Clear screen</span>
<span class="n">display</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">rotation</span><span class="p">)</span>
<span class="n">backlight</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">quit</span><span class="p">()</span>
</code></pre></div>

<h2>Run at Boot</h2>
<p>I used cron to schedule toycam at boot.
"crontab -e" is the command to bring up the cron file to edit
<code>@reboot python3 /home/pi/toycam.py &amp;</code></p>
<h2>Improvements</h2>
<ul>
<li>3D printed case</li>
<li>Battery</li>
<li>Sleep mode?</li>
<li>More filter modes</li>
<li>On/off switch </li>
<li>MeanShift segmentation mode</li>
</ul>
  </div>
  <div class="article_meta">
    <p>Category: <a href="/category/project.html">Project</a>
    </p>
  </div>


</article>


    <div id="ending_message">
      <p>&copy; Daniel Oberbauer. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>