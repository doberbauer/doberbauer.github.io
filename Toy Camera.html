<h3 id="what-is-toy-camera">What is Toy Camera?</h3>
<p>Toy Camera is a Raspberry Pi Zero W / OpenCV / Python project. It’s a
low resolution camera that can take pictures with a handful of filters.
It’s front-facing so you can take selfies and whatnot.</p>
<h3 id="why-did-you-make-it">Why did you make it?</h3>
<ul>
<li>I wanted to</li>
<li>I had the parts</li>
<li>It was a fun Python exercise</li>
<li>My Pi Zero W wasn’t being used</li>
</ul>
<h3 id="what-parts-did-you-use">What parts did you use?</h3>
<ul>
<li>Raspberry Pi Zero W</li>
<li>32 GB microSD</li>
<li>Adafruit 1.8in TFT</li>
<li>Raspberry Pi Camera module (or third-party raspberry pi compatible
camera)</li>
<li>Camera cable</li>
<li>Case</li>
</ul>
<p>(Future) - Battery - battery charging circuit</p>
<h3 id="how-do-i-install-this">How do I install this?</h3>
<p>I’m using Raspberry Pi OS Buster Lite (no desktop). I haven’t tried
other OS versions. Installing an OS is beyond the scope of this
article.</p>
<p>Let’s start with updating apt, installing pip, git and PIL.</p>
<pre class="terminal"><code>sudo apt-get update
sudo apt-get upgrade
sudo apt-get install python3-pip
sudo apt-get install git
sudo apt-get install python3-pil</code></pre>
<pre class="terminal"><code>sudo pip3 install --upgrade setuptools
cd ~
sudo pip3 install --upgrade adafruit-python-shell
wget https://raw.githubusercontent.com/adafruit/Raspberry-Pi-Installer-Scripts/master/raspi-blinka.py
sudo python3 raspi-blinka.py

pip3 install adafruit-circuitpython-rgb-display
pip3 install --upgrade --force-reinstall spidev
sudo apt-get install fonts-dejavu

sudo pip3 install opencv-python --no-cache-dir

# If pip doesn&#39;t work
sudo apt install cmake build-essential pkg-config git
sudo apt install libjpeg-dev libtiff-dev libjasper-dev libpng-dev libwebp-dev libopenexr-dev
sudo apt install libavcodec-dev libavformat-dev libswscale-dev libv4l-dev libxvidcore-dev libx264-dev libdc1394-22-dev libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev
sudo apt-get install python3-numpy
sudo apt install libgtk-3-dev libqtgui4 libqtwebkit4 libqt4-test python3-pyqt5
sudo apt install libatlas-base-dev liblapacke-dev gfortran
sudo apt install libhdf5-dev libhdf5-103
sudo apt install python3-dev python3-pip python3-numpy
git clone https://github.com/opencv/opencv.git
git clone https://github.com/opencv/opencv_contrib.git</code></pre>
<h3 id="how-does-it-work">How does it work?</h3>
<p><strong>Overview</strong></p>
<p>The Adafruit TFT for Raspberry Pi has two buttons. I’ve set it up so
the left button takes a picture and the right button changes mode.
Pressing both buttons shuts the Pi off.</p>
<p>TFT Display Definitions Code adapted from ladyada of Adafruit
Industries.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="an">SPDX-FileCopyrightText:</span><span class="co"> 2021 ladyada for Adafruit Industries</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="an">SPDX-License-Identifier:</span><span class="co"> MIT</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="st">&#39;/home/pi/.local/lib/python3/site-packages&#39;</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> digitalio</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> board</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> adafruit_rgb_display <span class="im">import</span> st7789</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image, ImageDraw, ImageFont</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">#from adafruit_rgb_display.rgb import color565</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Display definitions &#39;&#39;&#39;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuration for CS and DC pins for Raspberry Pi</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>cs_pin <span class="op">=</span> digitalio.DigitalInOut(board.CE0)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>dc_pin <span class="op">=</span> digitalio.DigitalInOut(board.D25)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>reset_pin <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>BAUDRATE <span class="op">=</span> <span class="dv">64000000</span>  <span class="co"># The pi can be very fast!</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the ST7789 display:</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>display <span class="op">=</span> st7789.ST7789(</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    board.SPI(),</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    cs<span class="op">=</span>cs_pin,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    dc<span class="op">=</span>dc_pin,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    rst<span class="op">=</span>reset_pin,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    baudrate<span class="op">=</span>BAUDRATE,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">240</span>,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">240</span>,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    x_offset<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    y_offset<span class="op">=</span><span class="dv">80</span>,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>backlight <span class="op">=</span> digitalio.DigitalInOut(board.D22)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>backlight.switch_to_output()</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>backlight.value <span class="op">=</span> <span class="va">True</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>buttonA <span class="op">=</span> digitalio.DigitalInOut(board.D23)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>buttonB <span class="op">=</span> digitalio.DigitalInOut(board.D24)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>buttonA.switch_to_input()</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>buttonB.switch_to_input()</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Image Definitions &#39;&#39;&#39;</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>height <span class="op">=</span> display.width  <span class="co"># swap height/width to make it landscape!</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> display.height</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> Image.new(<span class="st">&quot;RGB&quot;</span>, (width, height))</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>rotation <span class="op">=</span> <span class="dv">270</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>text_rotation <span class="op">=</span> <span class="dv">90</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>text_x <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>text_y <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>draw <span class="op">=</span> ImageDraw.Draw(image)</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>draw.rectangle((<span class="dv">0</span>, <span class="dv">0</span>, width, height), outline<span class="op">=</span><span class="dv">0</span>, fill<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)) <span class="co">#Clear screen</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>display.image(image, rotation)</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>font <span class="op">=</span> ImageFont.truetype(<span class="st">&quot;/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf&quot;</span>, <span class="dv">24</span>)</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Camera definitions &#39;&#39;&#39;</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>cap <span class="op">=</span> cv2.VideoCapture(<span class="dv">0</span>)</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>dim <span class="op">=</span> (<span class="dv">240</span>,<span class="dv">180</span>)</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>cap_w <span class="op">=</span> <span class="dv">640</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>cap_h <span class="op">=</span> <span class="dv">480</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>cap.<span class="bu">set</span>(cv2.CAP_PROP_FRAME_WIDTH, cap_w)</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>cap.<span class="bu">set</span>(cv2.CAP_PROP_FRAME_HEIGHT, cap_h)</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Mode definitions &#39;&#39;&#39;</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>current_mode <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>modes <span class="op">=</span> [<span class="st">&quot;Default&quot;</span>,<span class="st">&quot;Pixel&quot;</span>,<span class="st">&quot;BW&quot;</span>,<span class="st">&quot;Negative&quot;</span>,<span class="st">&quot;Sepia&quot;</span>,<span class="st">&quot;Sketch&quot;</span>,<span class="st">&quot;Water color&quot;</span>,<span class="st">&quot;Detect Face&quot;</span>,<span class="st">&quot;Psychedelic&quot;</span>] <span class="co">#Mode str len &lt;= x chars</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> face_cascade</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>face_cascade <span class="op">=</span> cv2.CascadeClassifier(<span class="st">&#39;haarcascade_frontalface_default.xml&#39;</span>)</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Cycle Mode Function &#39;&#39;&#39;</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cycle_mode(_current_mode,_modes):</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _current_mode <span class="op">==</span> <span class="bu">len</span>(_modes)<span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>        _current_mode <span class="op">=</span> <span class="dv">0</span>  <span class="co">#reset it to zero</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>        _current_mode <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _current_mode</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_frame(frame,current_mode,modes):</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    mode <span class="op">=</span> modes[current_mode]</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mode <span class="op">==</span> modes[<span class="dv">0</span>]: <span class="co">#Default</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mode <span class="op">==</span> modes[<span class="dv">1</span>]: <span class="co">#Pixel</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> mode_pixel(frame)</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mode <span class="op">==</span> modes[<span class="dv">2</span>]: <span class="co">#BW</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> mode_bw(frame)</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mode <span class="op">==</span> modes[<span class="dv">3</span>]: <span class="co">#Negative</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> mode_negative(frame)</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mode <span class="op">==</span> modes[<span class="dv">4</span>]: <span class="co">#Sepia</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> mode_sepia(frame)</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mode <span class="op">==</span> modes[<span class="dv">5</span>]: <span class="co">#Sketch</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> mode_sketch(frame)</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mode <span class="op">==</span> modes[<span class="dv">6</span>]: <span class="co">#Water color</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> mode_wc(frame)</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mode <span class="op">==</span> modes[<span class="dv">7</span>]: <span class="co">#Detect Face</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> mode_face(frame)</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mode <span class="op">==</span> modes[<span class="dv">8</span>]: <span class="co">#Psychedelic</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> mode_psych(frame)</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> frame</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; --- MODES --- &#39;&#39;&#39;</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Pixel Mode &#39;&#39;&#39;</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mode_pixel(frame):</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>    fh, fw, _ <span class="op">=</span> frame.shape</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>    h, w <span class="op">=</span> (<span class="dv">16</span>, <span class="dv">16</span>)</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>    temp <span class="op">=</span> cv2.resize(frame, (w, h), interpolation<span class="op">=</span>cv2.INTER_LINEAR)</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cv2.resize(temp, (fw, fh), interpolation<span class="op">=</span>cv2.INTER_NEAREST)</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; BW Mode &#39;&#39;&#39;</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mode_bw(frame):</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>    frame <span class="op">=</span> cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> frame</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Negative Mode &#39;&#39;&#39;</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mode_negative(frame):</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>    frame <span class="op">=</span> cv2.bitwise_not(frame)</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> frame</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Sepia Mode &#39;&#39;&#39;</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mode_sepia(frame):</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>    frame <span class="op">=</span> np.array(frame, dtype<span class="op">=</span>np.float64)</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>    frame <span class="op">=</span> cv2.transform(frame, np.matrix([[<span class="fl">0.272</span>, <span class="fl">0.534</span>, <span class="fl">0.131</span>],</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>                                    [<span class="fl">0.349</span>, <span class="fl">0.686</span>, <span class="fl">0.168</span>],</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>                                    [<span class="fl">0.393</span>, <span class="fl">0.769</span>, <span class="fl">0.189</span>]])) <span class="co"># multipying image with special sepia matrix</span></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>    frame[np.where(frame <span class="op">&gt;</span> <span class="dv">255</span>)] <span class="op">=</span> <span class="dv">255</span> <span class="co"># normalizing values greater than 255 to 255</span></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>    frame <span class="op">=</span> np.array(frame, dtype<span class="op">=</span>np.uint8) <span class="co"># converting back to int</span></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> frame</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Sketch Mode &#39;&#39;&#39;</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mode_sketch(frame):</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>    _, frame <span class="op">=</span> cv2.pencilSketch(frame, sigma_s<span class="op">=</span><span class="dv">60</span>, sigma_r<span class="op">=</span><span class="fl">0.07</span>, shade_factor<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> frame</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Water Color Mode &#39;&#39;&#39;</span></span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mode_wc(frame):</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>    frame <span class="op">=</span> cv2.stylization(frame, sigma_s<span class="op">=</span><span class="dv">60</span>, sigma_r<span class="op">=</span><span class="fl">0.07</span>)</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> frame</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Face Detection Mode &#39;&#39;&#39;</span></span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mode_face(frame):</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>    gray <span class="op">=</span> cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>    faces <span class="op">=</span> face_cascade.detectMultiScale(gray, scaleFactor<span class="op">=</span><span class="fl">1.05</span>, minNeighbors<span class="op">=</span><span class="dv">5</span>, minSize<span class="op">=</span>(<span class="dv">30</span>, <span class="dv">30</span>))</span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">len</span>(faces))</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (x,y,w,h) <span class="kw">in</span> faces:</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>        cv2.rectangle(frame,(x,y),(x<span class="op">+</span>w,y<span class="op">+</span>h),color<span class="op">=</span>(<span class="dv">255</span>,<span class="dv">255</span>,<span class="dv">0</span>),thickness<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> frame</span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Psychedelic Color Mode &#39;&#39;&#39;</span></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mode_psych(frame):</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>    img_hsv <span class="op">=</span> cv2.cvtColor(frame,cv2.COLOR_BGR2HSV)</span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>    n_shift <span class="op">=</span> <span class="dv">180</span> <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>    img_hsv[:,:,<span class="dv">0</span>] <span class="op">=</span> (img_hsv[:,:,<span class="dv">0</span>].astype(<span class="bu">int</span>) <span class="op">+</span> n_shift) <span class="op">%</span> <span class="dv">181</span></span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>    frame <span class="op">=</span> cv2.cvtColor(img_hsv, cv2.COLOR_HSV2BGR)</span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> frame</span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a><span class="co">&#39;&#39;&#39; Main loop &#39;&#39;&#39;</span></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> buttonA.value <span class="kw">and</span> buttonB.value: <span class="co"># none pressed</span></span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Viewfinder</span></span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>        _, frame <span class="op">=</span> cap.read()</span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)</span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> cv2.resize(frame,dim)</span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> Image.fromarray(frame)</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> frame.transpose(Image.FLIP_LEFT_RIGHT)</span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>        display.image(frame,rotation)</span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> buttonB.value <span class="kw">and</span> <span class="kw">not</span> buttonA.value:  <span class="co"># just button A pressed</span></span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Take picture and display result for 5 seconds</span></span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>        _, frame <span class="op">=</span> cap.read()</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a>        draw.rectangle((<span class="dv">0</span>, <span class="dv">0</span>, width, height), outline<span class="op">=</span><span class="dv">0</span>, fill<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>        draw.text((text_x, text_y), <span class="st">&quot;Processing...&quot;</span>, font<span class="op">=</span>font, fill<span class="op">=</span><span class="st">&quot;#FFFFFF&quot;</span>)</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>        display.image(image, text_rotation)</span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> process_frame(frame,current_mode,modes)</span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>        timestr <span class="op">=</span> time.strftime(<span class="st">&quot;%Y-%m-</span><span class="sc">%d</span><span class="st">--%H-%M-%S&quot;</span>)</span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> <span class="st">&quot;pics/&quot;</span> <span class="op">+</span> modes[current_mode] <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="op">+</span> timestr <span class="op">+</span> <span class="st">&quot;.jpg&quot;</span></span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> cv2.imwrite(filename, frame)</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>        draw.rectangle((<span class="dv">0</span>, <span class="dv">0</span>, width, height), outline<span class="op">=</span><span class="dv">0</span>, fill<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a>        draw.text((text_x, text_y), <span class="st">&quot;Done!&quot;</span>, font<span class="op">=</span>font, fill<span class="op">=</span><span class="st">&quot;#FFFFFF&quot;</span>)</span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>        display.image(image, text_rotation)</span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)</span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> cv2.resize(frame,dim)</span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>        frame <span class="op">=</span> Image.fromarray(frame)</span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a>        display.image(frame, rotation) <span class="co">#Display it</span></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">5</span>)   <span class="co"># Wait for a few seconds (ms?) </span></span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a>        draw.rectangle((<span class="dv">0</span>, <span class="dv">0</span>, width, height), outline<span class="op">=</span><span class="dv">0</span>, fill<span class="op">=</span><span class="dv">0</span>) <span class="co">#Clear screen</span></span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a>        draw.text((text_x,text_y), modes[current_mode], font<span class="op">=</span>font, fill<span class="op">=</span><span class="st">&quot;#FFFFFF&quot;</span>) </span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a>        display.image(image, text_rotation) <span class="co">#Display the current mode</span></span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> buttonA.value <span class="kw">and</span> <span class="kw">not</span> buttonB.value:  <span class="co"># just button B pressed</span></span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Change Mode</span></span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a>        draw.rectangle((<span class="dv">0</span>, <span class="dv">0</span>, width, height), outline<span class="op">=</span><span class="dv">0</span>, fill<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a>        current_mode <span class="op">=</span> cycle_mode(current_mode,modes)</span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a>        draw.text((text_x, text_y), modes[current_mode], font<span class="op">=</span>font, fill<span class="op">=</span><span class="st">&quot;#FFFFFF&quot;</span>)</span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a>        display.image(image, text_rotation)</span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="fl">0.5</span>)</span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> buttonA.value <span class="kw">and</span> <span class="kw">not</span> buttonB.value:  <span class="co">#both pressed</span></span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a>        os.system(<span class="st">&#39;sudo showdown now&#39;</span>)</span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a>cap.release()</span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a>draw.rectangle((<span class="dv">0</span>, <span class="dv">0</span>, width, height), outline<span class="op">=</span><span class="dv">0</span>, fill<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)) <span class="co">#Clear screen</span></span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a>display.image(image, rotation)</span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a>backlight.value <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a>quit()</span></code></pre></div>
<h2 id="run-at-boot">Run at Boot</h2>
<p>I used cron to schedule toycam at boot. “crontab -e” is the command
to bring up the cron file to edit
<code>@reboot python3 /home/pi/toycam.py &amp;</code></p>
<h2 id="improvements">Improvements</h2>
<ul>
<li>3D printed case</li>
<li>Battery</li>
<li>Sleep mode?</li>
<li>More filter modes</li>
<li>On/off switch</li>
<li>MeanShift segmentation mode</li>
</ul>
